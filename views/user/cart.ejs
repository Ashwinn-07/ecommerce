<%-include("../../views/partials/user/header") %>
<!-- Header Section End -->

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <h4>Shopping Cart</h4>
          <div class="breadcrumb__links">
            <a href="/">Home</a>
            <a href="/shop">Shop</a>
            <span>Shopping Cart</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Shopping Cart Section Begin -->
<section class="shopping-cart spad">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <div class="shopping__cart__table">
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Total</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% if (cart && cart.items.length > 0) { %> <%
              cart.items.forEach(function(item) { %>
              <tr>
                <td class="product__cart__item">
                  <div class="product__cart__item__pic">
                    <img
                      src="/uploads/re-image/<%= item.productId.productImage[0] %>"
                      alt="<%= item.productId.productName %>"
                    />
                  </div>
                  <div class="product__cart__item__text">
                    <h6><%= item.productId.productName %></h6>
                  </div>
                </td>
                <td class="quantity__item">
                  <div class="quantity">
                    <div class="pro-qty-2">
                      <input
                        type="number"
                        value="<%= item.quantity %>"
                        min="1"
                        data-product-id="<%= item.productId ? item.productId._id : '' %>"
                        onchange="updateQuantity(this)"
                      />
                    </div>
                  </div>
                </td>
                <td class="cart__price">$ <%= item.totalPrice %></td>
                <td class="cart__close">
                  <form
                    action="/cart/remove/<%= item.productId._id %>"
                    method="POST"
                  >
                    <button type="submit"><i class="fa fa-close"></i></button>
                  </form>
                </td>
              </tr>
              <% }); %> <% } else { %>
              <tr>
                <td colspan="4">Your cart is empty.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="row">
          <div class="col-lg-6 col-md-6 col-sm-6">
            <div class="continue__btn">
              <a href="/shop">Continue Shopping</a>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="cart__discount">
          <h6>Discount codes</h6>
          <form action="#">
            <input type="text" placeholder="Coupon code" />
            <button type="submit">Apply</button>
          </form>
        </div>
        <div class="cart__total">
          <h6>Cart total</h6>
          <ul>
            <li>Subtotal <span>$ <%= total %></span></li>
            <li>Total <span>$ <%= total %></span></li>
          </ul>
          <a href="/checkout" class="primary-btn">Proceed to checkout</a>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Shopping Cart Section End -->

<script>
  function updateQuantity(input) {
    console.log("updateQuantity called with value:", input.value);
    const productId = input.dataset.productId;
    const newQuantity = input.value;

    fetch("/cart/update", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ productId, quantity: newQuantity }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const row = input.closest("tr");
          const totalPriceCell = row.querySelector(".cart__price");
          totalPriceCell.textContent = `$ ${data.newItemTotal.toFixed(2)}`;

          updateCartTotal(data.newCartTotal);
        } else {
          alert(data.message);

          input.value = input.defaultValue;
        }
      })
      .catch((error) => {
        console.error("Error:", error);

        input.value = input.defaultValue;
      });
  }

  function updateCartTotal(newTotal) {
    const cartTotalElement = document.getElementById("cartTotal");
    if (cartTotalElement) {
      cartTotalElement.textContent = `$ ${newTotal.toFixed(2)}`;
    }
  }

  function refreshCartTotal() {
    fetch("/cart/total")
      .then((response) => response.json())
      .then((data) => {
        updateCartTotal(data.total);
      })
      .catch((error) => {
        console.error("Error fetching cart total:", error);
      });
  }
</script>

<!-- Footer Section Begin -->
<%-include("../../views/partials/user/footer") %>
