<%-include("../../views/partials/user/header") %>
<!-- Header Section End -->

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <h4>Check Out</h4>
          <div class="breadcrumb__links">
            <a href="/">Home</a>
            <a href="/shop">Shop</a>
            <span>Check Out</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
  <div class="container">
    <div class="checkout__form">
      <form action="/checkout/place-order" method="post" id="checkoutForm">
        <div class="row">
          <div class="col-lg-8 col-md-6">
            <div class="checkout__input">
              <p>Select Coupon</p>
              <select id="couponSelect" name="couponSelect">
                <option value="">Select Coupon</option>
                <% availableCoupons.forEach((coupon) => { %>
                  <option
                    value="<%= coupon._id %>"
                    data-discount="<%= coupon.offerPrice %>"
                    <%= (appliedCouponId && appliedCouponId.toString() === coupon._id.toString()) ? 'selected' : '' %>
                  >
                    <%= coupon.name %> - Save $<%= coupon.offerPrice %> (Min Order $<%= coupon.minimumPrice %>)
                  </option>
                <% }); %>
              </select>
              <p id="couponMessage"></p>
            </div>

            <div>
              <h3>Saved Addresses</h3>
              <% if (addresses && addresses.length > 0) { %> <%
              addresses.forEach((addressEntry) => { %> <% if
              (addressEntry.address && addressEntry.address.length > 0) { %> <%
              addressEntry.address.forEach((address) => { %>
              <div>
                <input
                  type="radio"
                  name="addressId"
                  value="<%= address._id %>"
                />
                <label
                  ><%= address.name %>, <%= address.addressType %>, <%=
                  address.city %>, <%= address.state %>, <%= address.pincode
                  %></label
                >
              </div>
              <% }) %> <% } %> <% }) %> <% } else { %>
              <p>No saved addresses. Please add a new address below.</p>
              <% } %>
            </div>

            <!-- New Address Form -->
            <h6 class="checkout__title">Add New Address</h6>
            <div class="row">
              <div class="col-lg-6">
                <div class="checkout__input">
                  <p>Name<span>*</span></p>
                  <input type="text" name="newAddress[name]" />
                </div>
              </div>
              <div class="col-lg-6">
                <div class="checkout__input">
                  <p>Address Type<span>*</span></p>
                  <input type="text" name="newAddress[addressType]" />
                </div>
              </div>
            </div>
            <div class="checkout__input">
              <p>City<span>*</span></p>
              <input type="text" name="newAddress[city]" />
            </div>
            <div class="checkout__input">
              <p>State<span>*</span></p>
              <input type="text" name="newAddress[state]" />
            </div>
            <div class="checkout__input">
              <p>Pincode<span>*</span></p>
              <input type="text" name="newAddress[pincode]" />
            </div>
            <div class="checkout__input">
              <p>Phone<span>*</span></p>
              <input type="text" name="newAddress[phone]" />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="checkout__order">
              <h4 class="order__title">Your order</h4>
              <div class="checkout__order__products">
                Product <span>Total</span>
              </div>
              <ul class="checkout__total__products">
                <% cart.items.forEach((item) => { %>
                <li>
                  <%= item.productId.productName %>
                  <span>$ <%= item.totalPrice.toFixed(2) %></span>
                </li>
                <% }); %>
              </ul>
              <ul class="checkout__total__all">
                <li>
                  Subtotal
                  <span
                    >$<span id="subtotal"><%= total.toFixed(2) %></span></span
                  >
                </li>
                <li>
                  Discount
                  <span
                    >$<span id="discount"
                      ><%= discount.toFixed(2) %></span
                    ></span
                  >
                </li>
                <li>
                  Total
                  <span
                    >$<span id="totalAmount"
                      ><%= finalAmount.toFixed(2) %></span
                    ></span
                  >
                </li>
              </ul>
              <div class="checkout__input__checkbox">
                <label for="payment">
                  COD
                  <input
                    type="radio"
                    name="paymentMethod"
                    value="COD"
                    id="payment"
                    required
                  />
                  <span class="checkmark"></span>
                </label>
              </div>
              <div class="checkout__input__checkbox">
                <label for="paypal">
                  PayPal
                  <input
                    type="radio"
                    name="paymentMethod"
                    value="PayPal"
                    id="paypal"
                  />
                  <span class="checkmark"></span>
                </label>
              </div>
              <button type="submit" class="site-btn">PLACE ORDER</button>
            </div>
          </div>
        </div>

        <input
          type="hidden"
          name="appliedCouponId"
          id="appliedCouponId"
          value=""
        />
        <input
          type="hidden"
          name="discountAmount"
          id="discountAmount"
          value="0"
        />
      </form>
    </div>
  </div>
</section>
<!-- Checkout Section End -->

<script>
  document
    .getElementById("couponSelect")
    .addEventListener("change", async function () {
      const form = document.getElementById("checkoutForm");
      const formData = new FormData(form);

      try {
        const response = await fetch("/apply-coupon", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          document.getElementById("discount").innerText =
            result.discount.toFixed(2);
          document.getElementById("totalAmount").innerText =
            result.newTotal.toFixed(2);
          document.getElementById("couponMessage").innerText =
            "Coupon applied successfully!";
        } else {
          document.getElementById("discount").innerText = "0.00";
          document.getElementById("totalAmount").innerText =
            document.getElementById("subtotal").innerText;
          document.getElementById("couponMessage").innerText =
            result.message || "Coupon is not valid!";
        }
      } catch (error) {
        console.error("Error applying coupon:", error);
        document.getElementById("couponMessage").innerText =
          "An error occurred while applying the coupon.";
      }
    });
</script>
<!-- Footer Section Begin -->
<%-include("../../views/partials/user/footer") %>
