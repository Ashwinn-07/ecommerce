<%-include("../../views/partials/user/header") %>
<!-- Header Section End -->

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <div class="breadcrumb__text">
          <h4>Check Out</h4>
          <div class="breadcrumb__links">
            <a href="/">Home</a>
            <a href="/shop">Shop</a>
            <span>Check Out</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
  <div class="container">
    <div class="checkout__form">
      <form action="/checkout/place-order" method="post" id="checkoutForm">
        <div class="row">
          <div class="col-lg-8 col-md-6">
            <div class="checkout__input">
              <p>Select Coupon</p>
              <select id="couponSelect" name="couponSelect">
                <option value="">Select Coupon</option>
                <% availableCoupons.forEach((coupon) => { %>
                <option
                  value="<%= coupon._id %>"
                  data-discount="<%= coupon.offerPrice %>"
                >
                  <%= coupon.name %> - Save $<%= coupon.offerPrice %> (Min Order
                  $<%= coupon.minimumPrice %>)
                </option>
                <% }); %>
              </select>
              <p id="couponMessage"></p>
            </div>

            <div>
              <h3>Saved Addresses</h3>
              <% if (addresses && addresses.length > 0) { %> <%
              addresses.forEach((addressEntry) => { %> <% if
              (addressEntry.address && addressEntry.address.length > 0) { %> <%
              addressEntry.address.forEach((address) => { %>
              <div>
                <input
                  type="radio"
                  name="addressId"
                  value="<%= address._id %>"
                />
                <label
                  ><%= address.name %>, <%= address.addressType %>, <%=
                  address.city %>, <%= address.state %>, <%= address.pincode
                  %></label
                >
              </div>
              <% }) %> <% } %> <% }) %> <% } else { %>
              <p>No saved addresses. Please add a new address below.</p>
              <% } %>
            </div>

            <!-- New Address Form -->
            <h6 class="checkout__title">Add New Address</h6>
            <div class="row">
              <div class="col-lg-6">
                <div class="checkout__input">
                  <p>Name<span>*</span></p>
                  <input type="text" name="newAddress[name]" />
                </div>
              </div>
              <div class="col-lg-6">
                <div class="checkout__input">
                  <p>Address Type<span>*</span></p>
                  <input type="text" name="newAddress[addressType]" />
                </div>
              </div>
            </div>
            <div class="checkout__input">
              <p>City<span>*</span></p>
              <input type="text" name="newAddress[city]" />
            </div>
            <div class="checkout__input">
              <p>State<span>*</span></p>
              <input type="text" name="newAddress[state]" />
            </div>
            <div class="checkout__input">
              <p>Pincode<span>*</span></p>
              <input type="text" name="newAddress[pincode]" />
            </div>
            <div class="checkout__input">
              <p>Phone<span>*</span></p>
              <input type="text" name="newAddress[phone]" />
            </div>
          </div>

          <div class="col-lg-4 col-md-6">
            <div class="checkout__order">
              <h4 class="order__title">Your order</h4>
              <div class="checkout__order__products">
                Product <span>Total</span>
              </div>
              <ul class="checkout__total__products">
                <% cart.items.forEach((item) => { %>
                <li>
                  <%= item.productId.productName %>
                  <span>$ <%= item.totalPrice.toFixed(2) %></span>
                </li>
                <% }); %>
              </ul>
              <ul class="checkout__total__all">
                <li>
                  Subtotal
                  <span>$<span id="subtotal"><%= total %></span></span>
                </li>
                <li>
                  Discount <span>$<span id="discount">0.00</span></span>
                </li>
                <li>
                  Total <span>$<span id="totalAmount"><%= total %></span></span>
                </li>
              </ul>
              <div class="checkout__input__checkbox">
                <label for="payment">
                  COD
                  <input
                    type="radio"
                    name="paymentMethod"
                    value="COD"
                    id="payment"
                    required
                  />
                  <span class="checkmark"></span>
                </label>
              </div>
              <div class="checkout__input__checkbox">
                <label for="paypal">
                  PayPal
                  <input
                    type="radio"
                    name="paymentMethod"
                    value="PayPal"
                    id="paypal"
                  />
                  <span class="checkmark"></span>
                </label>
              </div>
              <button type="submit" class="site-btn">PLACE ORDER</button>
            </div>
          </div>
        </div>

        <input
          type="hidden"
          name="appliedCouponId"
          id="appliedCouponId"
          value=""
        />
        <input
          type="hidden"
          name="discountAmount"
          id="discountAmount"
          value="0"
        />
      </form>
    </div>
  </div>
</section>
<!-- Checkout Section End -->

<!-- Footer Section Begin -->
<%-include("../../views/partials/user/footer") %>

<script>
  let discountAmount = 0;
  let appliedCouponId = "";

  document
    .getElementById("couponSelect")
    .addEventListener("change", async function () {
      const selectedCoupon = this.value;
      const subtotal = parseFloat(
        document.getElementById("subtotal").innerText
      );

      if (selectedCoupon) {
        try {
          const response = await fetch(`/validate-coupon/${selectedCoupon}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ subtotal }),
          });

          const result = await response.json();

          if (result.isValid) {
            const discount = result.discount;
            const newTotal = subtotal - discount;
            document.getElementById("discount").innerText = discount.toFixed(2);
            document.getElementById("totalAmount").innerText =
              newTotal.toFixed(2);
            document.getElementById("couponMessage").innerText =
              "Coupon applied successfully!";

            document.getElementById("appliedCouponId").value = selectedCoupon;
            document.getElementById("discountAmount").value =
              discount.toFixed(2);
          } else {
            document.getElementById("couponMessage").innerText =
              "Coupon is not valid!";
            resetCouponFields();
          }
        } catch (error) {
          console.error("Error validating coupon:", error);
          resetCouponFields();
        }
      } else {
        resetCouponFields();
      }
    });

  function resetCouponFields() {
    const subtotal = parseFloat(document.getElementById("subtotal").innerText);
    document.getElementById("discount").innerText = "0.00";
    document.getElementById("totalAmount").innerText = subtotal.toFixed(2);
    document.getElementById("couponMessage").innerText = "";
    document.getElementById("appliedCouponId").value = "";
    document.getElementById("discountAmount").value = "0";
  }
</script>
